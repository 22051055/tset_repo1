<!DOCTYPE html>
<html>
<head>
    <title>笹ヶ峰to西登山口</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <style>
        #map, #graph {
            width: 100%;
            height: 50vh;
        }
        #slider-container {
            display: flex;
            justify-content: center;
            margin-top: 0px;
        }
        #slider {
            width: 100%;
        }
        #distances, #elevations {
            text-align: center;
            margin-top: 10px;
        }        
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
</head>
<body>
    <div id="title"><a>笹ヶ峰to西登山口</a></div>
    <div id="map"></div>
    <div id="graph" style="touch-action: manipulation;"></div>
    <div id="slider-container">
        <input type="range" id="slider" min="0" max="100" value="0" />
    </div>
    <div id="distances">
        <p>水平距離: <span id="horizontal-distance"></span> km</p>
        <p>沿面距離: <span id="surface-distance"></span> km</p>
    </div>
    <div id="elevations">
        <p>累積標高上り: <span id="total-ascent"></span> m</p>
        <p>累積標高下り: <span id="total-descent"></span> m</p>
        <p>最高標高: <span id="max-elevation"></span> m</p>
        <p>最低標高: <span id="min-elevation"></span> m</p>
    </div>
    <div>
        <a href="2-1_Sasagamine_to_Nishitozannguthi.gpx" download>GPXファイルをダウンロード</a>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
　　<script>
        $(document).ready(function() {
            // 地図の初期化
            var map = L.map('map').setView([36.85559, 138.09872], 14);
            L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>'
            }).addTo(map);

            // GPXトラックの表示
            var latlngs = [
                
                    [36.85559, 138.09872, 1285.8,],

                    [36.85564, 138.09849, 1287.9,],

                    [36.85559, 138.09792, 1292.7,],

                    [36.85546, 138.09752, 1296.2,],

                    [36.85548, 138.09731, 1297.3,],

                    [36.85571, 138.09719, 1297.7,],

                    [36.85578, 138.09714, 1298.2,],

                    [36.85581, 138.09703, 1298.3,],

                    [36.85581, 138.09693, 1298.4,],

                    [36.85612, 138.09682, 1299.7,],

                    [36.8562, 138.09682, 1300.4,],

                    [36.85635, 138.0967, 1301.2,],

                    [36.85651, 138.09659, 1301.2,],

                    [36.85664, 138.09669, 1301.8,],

                    [36.85678, 138.09679, 1302.5,],

                    [36.85704, 138.09686, 1303.7,],

                    [36.8573, 138.0969, 1305.3,],

                    [36.85744, 138.09703, 1306,],

                    [36.85765, 138.097, 1306.9,],

                    [36.85803, 138.09673, 1307.4,],

                    [36.85833, 138.09653, 1307.4,],

                    [36.85843, 138.09646, 1307.4,],

                    [36.85857, 138.09636, 1307.5,],

                    [36.85867, 138.09618, 1306.5,],

                    [36.85871, 138.09599, 1304.8,],

                    [36.85876, 138.09582, 1303.8,],

                    [36.85882, 138.09558, 1302.5,],

                    [36.85886, 138.09533, 1301,],

                    [36.85893, 138.09498, 1298.2,],

                    [36.85902, 138.09458, 1295.6,],

                    [36.85905, 138.09445, 1294.9,],

                    [36.85912, 138.09412, 1293,],

                    [36.8592, 138.09383, 1290.7,],

                    [36.85925, 138.09372, 1289.7,],

                    [36.85936, 138.09353, 1288.1,],

                    [36.8595, 138.09323, 1286.6,],

                    [36.85968, 138.0929, 1287.2,],

                    [36.85998, 138.09242, 1283.6,],

                    [36.86013, 138.09229, 1282.7,],

                    [36.86034, 138.09222, 1281.4,],

                    [36.86064, 138.09218, 1281.5,],

                    [36.86107, 138.09214, 1285.3,],

                    [36.86155, 138.09213, 1289.9,],

                    [36.86176, 138.09207, 1291.3,],

                    [36.862, 138.09193, 1292.2,],

                    [36.86211, 138.0919, 1292.4,],

                    [36.86226, 138.09185, 1294.1,],

                    [36.86234, 138.09178, 1294.2,],

                    [36.86239, 138.09171, 1295.2,],

                    [36.86245, 138.0915, 1294.9,],

                    [36.86244, 138.09097, 1296.4,],

                    [36.86245, 138.09061, 1298.5,],

                    [36.86247, 138.09054, 1299.2,],

                    [36.86255, 138.0903, 1300.3,],

                    [36.86264, 138.09004, 1302.7,],

                    [36.8627, 138.08984, 1304.4,],

                    [36.86283, 138.08945, 1303,],

                    [36.86298, 138.08905, 1300.7,],

                    [36.86323, 138.08852, 1302.3,],

                    [36.86335, 138.08816, 1302.4,],

                    [36.86351, 138.08766, 1300.8,],

                    [36.86368, 138.08712, 1299.5,],

                    [36.86382, 138.08682, 1299.3,],

                    [36.86405, 138.08658, 1300,],

                    [36.86441, 138.08643, 1300.6,],

                    [36.86469, 138.08616, 1301.8,],

                    [36.86495, 138.08578, 1301.2,],

                    [36.86506, 138.0856, 1301.2,],

                    [36.86512, 138.08549, 1301,],

                    [36.86523, 138.08537, 1297.7,],

                    [36.86523, 138.08529, 1298.2,],

                    [36.86522, 138.08512, 1300.4,],

                    [36.86528, 138.08512, 1301.1,],

                    [36.86562, 138.08533, 1304.4,],

                    [36.86614, 138.08566, 1309.6,],

                    [36.86644, 138.08585, 1313.5,],

                    [36.86647, 138.08586, 1313.5,],

                    [36.86652, 138.08585, 1314.2,],

                    [36.86657, 138.0858, 1314.4,],

                    [36.86666, 138.08571, 1314.6,],

                    [36.8668, 138.08554, 1314.7,],

                    [36.86689, 138.0854, 1315.5,],

                    [36.86696, 138.08528, 1316.3,],

                    [36.86702, 138.08517, 1316.4,],

                    [36.86712, 138.08506, 1317.1,],

                    [36.86717, 138.08501, 1317.8,],

                    [36.86737, 138.08475, 1321.7,],

                    [36.86742, 138.08462, 1321.2,],

                    [36.86712, 138.08422, 1316.2,],

                    [36.86701, 138.08414, 1314.7,],

                    [36.86662, 138.08408, 1310.1,],

                    [36.86648, 138.08399, 1308,],

                    [36.86644, 138.08392, 1307.2,],

                    [36.86643, 138.08381, 1305.9,],

                    [36.86649, 138.08361, 1305.6,],

                    [36.86648, 138.08341, 1303.7,],

                    [36.86644, 138.08321, 1302,],

                    [36.86642, 138.08311, 1301,],

                    [36.86647, 138.08295, 1300.3,],

                    [36.86658, 138.0827, 1296.8,],

                    [36.86658, 138.08261, 1296.2,],

                    [36.86648, 138.08247, 1298.5,],

                    [36.86647, 138.08219, 1298.4,],

                    [36.86643, 138.08191, 1297,],

                    [36.86652, 138.08069, 1295.1,],

                    [36.86647, 138.08018, 1289.8,],

                    [36.86647, 138.07964, 1293,],

                    [36.86663, 138.07905, 1295.2,],

                    [36.86663, 138.07902, 1295.1,],

                    [36.86632, 138.07889, 1291.8,],

                    [36.86599, 138.07881, 1288.9,],

                    [36.86581, 138.07887, 1287.1,],

                    [36.86565, 138.07899, 1285.5,],

                    [36.86527, 138.07907, 1281.4,],

                    [36.86495, 138.07907, 1279.5,],

                    [36.86472, 138.079, 1277.1,],

                    [36.86428, 138.07863, 1272.3,],

                    [36.86403, 138.07843, 1269.6,],

                    [36.86385, 138.0783, 1268,],

                    [36.86366, 138.07825, 1266.9,],

                    [36.86329, 138.07811, 1263.9,],

                    [36.86305, 138.07807, 1261.8,],

                    [36.86289, 138.07802, 1261.2,],

                    [36.86248, 138.07796, 1257.9,],

                    [36.86223, 138.07796, 1256.1,],

                    [36.86205, 138.07791, 1254.9,],

                    [36.86178, 138.07777, 1253.2,],

                    [36.86163, 138.07763, 1252.3,],

                    [36.86163, 138.07763, 1252.3,],

                    [36.86164, 138.07723, 1251.4,],

                    [36.86166, 138.07719, 1250.5,],

                    [36.86164, 138.07714, 1249.5,],

                    [36.86157, 138.07698, 1250.2,],

                    [36.86144, 138.07684, 1250.1,],

                    [36.86096, 138.07659, 1248.1,],

                    [36.86047, 138.07633, 1244.3,],

                    [36.86005, 138.07602, 1240.1,],

                    [36.85975, 138.07572, 1235.6,],

                    [36.85953, 138.07552, 1231.1,],

                    [36.85937, 138.07543, 1230.6,],

                    [36.85928, 138.07544, 1229.8,],

                    [36.8592, 138.07541, 1228.3,],

                    [36.85914, 138.07526, 1226.7,],

                    [36.8591, 138.07518, 1226,],

                    [36.85901, 138.07515, 1224.8,],

                    [36.85889, 138.07523, 1224,],

                    [36.85862, 138.0756, 1223.8,],

                    [36.85851, 138.07565, 1223.8,],

                    [36.85797, 138.07536, 1222.6,],

                    [36.85774, 138.07527, 1224.1,],

                    [36.85647, 138.07511, 1222.6,],

                    [36.85633, 138.07511, 1223,],

                    [36.85603, 138.0751, 1233.2,],

                    [36.85591, 138.0751, 1240.1,],

                    [36.85587, 138.07507, 1242.8,],

                    [36.85572, 138.07483, 1250.5,],

                    [36.85557, 138.07465, 1254,],

                    [36.85553, 138.07453, 1258.1,],

                    [36.85554, 138.07432, 1262.5,],

                    [36.85552, 138.07423, 1265.3,],

                    [36.85535, 138.07428, 1269.4,],

                    [36.85525, 138.07425, 1267.9,],

                    [36.85496, 138.07423, 1266.4,],

                    [36.85477, 138.07429, 1264.8,],

                    [36.85464, 138.07454, 1266.3,],

                    [36.85436, 138.07486, 1263.6,],

                    [36.85418, 138.07523, 1265.1,],

                    [36.85397, 138.07542, 1265.5,],

                    [36.85386, 138.07544, 1267.6,],

                    [36.85367, 138.07542, 1266.6,],

                    [36.85363, 138.07526, 1267,],

                    [36.85363, 138.07462, 1265.3,],

                    [36.85376, 138.07432, 1264.9,],

                    [36.85378, 138.07405, 1263.8,],

                    [36.85368, 138.07393, 1264.5,],

                    [36.85358, 138.07393, 1264.4,],

                    [36.85304, 138.07398, 1264.9,],

                    [36.85272, 138.07398, 1265.3,],

                    [36.85243, 138.07427, 1264.7,],

                    [36.85215, 138.07465, 1265.1,],

                    [36.85154, 138.07488, 1263.9,],

                    [36.85131, 138.07499, 1265.6,],

                    [36.85106, 138.07511, 1263.4,],

                    [36.85098, 138.07518, 1262.3,],

                    [36.85098, 138.07582, 1263.8,],

                    [36.85058, 138.07686, 1261.7,],

                    [36.85009, 138.07774, 1262.4,],

                    [36.84975, 138.07838, 1260.8,],

                    [36.84954, 138.07866, 1262.1,],

                    [36.84913, 138.07895, 1262.1,],

                    [36.84862, 138.07929, 1261.4,],

                    [36.84841, 138.07954, 1260.2,],

                    [36.84826, 138.08008, 1260.2,],

                    [36.84811, 138.08056, 1260,],

                    [36.84801, 138.08065, 1262.2,],

                    [36.84795, 138.08072, 1263.6,],

                    [36.8479, 138.08077, 1264.6,],

                    [36.84772, 138.08091, 1268.1,],

                    [36.84761, 138.08097, 1270,],

                    [36.84748, 138.08099, 1273,],

                    [36.84743, 138.08099, 1273.5,],

                    [36.84729, 138.08095, 1275.9,],

                    [36.84719, 138.08097, 1278.2,],

                    [36.84711, 138.08104, 1280.5,],

                    [36.84701, 138.08134, 1287.5,],

                    [36.84694, 138.08142, 1292.5,],

                    [36.8469, 138.08149, 1295,],

                    [36.84683, 138.08161, 1298,],

                    [36.84681, 138.08182, 1307.2,],

                    [36.84669, 138.08194, 1314,],

                    [36.84659, 138.08211, 1318.3,],

                    [36.84644, 138.08235, 1317.9,],

                    [36.84628, 138.08263, 1316,],

                    [36.8462, 138.08283, 1314.7,],

                    [36.84596, 138.08317, 1312.7,],

                    [36.84587, 138.08324, 1311.9,],

                    [36.84573, 138.0832, 1311.5,],

                    [36.84558, 138.08327, 1309,],

                    [36.84526, 138.08363, 1305.4,],

                    [36.84504, 138.08406, 1303.2,],

                    [36.84481, 138.08453, 1298,],

                    [36.84446, 138.08523, 1294.5,],

                    [36.84411, 138.08575, 1294.9,],

                    [36.84395, 138.08591, 1296.4,],

                    [36.84356, 138.08617, 1301.7,],

                    [36.8431, 138.08641, 1306.1,],

                    [36.84293, 138.08648, 1305.3,],

                    [36.84275, 138.08652, 1303.8,],

                    [36.84257, 138.08653, 1300.3,],

                    [36.84249, 138.08655, 1299.5,],

                    [36.84237, 138.08666, 1296.8,],

                    [36.84221, 138.08696, 1293.5,],

                    [36.84206, 138.08704, 1291.9,],

                    [36.84174, 138.08707, 1288.7,],

                    [36.84159, 138.08716, 1287.4,],

                    [36.84147, 138.0874, 1286.4,],

                    [36.84124, 138.08739, 1286.3,],

                    [36.84067, 138.08707, 1291.8,],

                    [36.84048, 138.08702, 1293.2,],

                    [36.84025, 138.08701, 1294,],

                    [36.84005, 138.08693, 1294.1,],

                    [36.83951, 138.08695, 1293.1,],

                    [36.83903, 138.08684, 1289.2,],

                    [36.83863, 138.08675, 1289.7,],

                    [36.83845, 138.08662, 1290.1,],

                    [36.83825, 138.08639, 1289.7,],

                    [36.83809, 138.08631, 1287.8,],

                    [36.83794, 138.08628, 1285.3,],

                    [36.83758, 138.08628, 1275.8,],

                    [36.83741, 138.08624, 1272.5,],

                    [36.83727, 138.08618, 1269.8,],

                    [36.83727, 138.08618, 1269.8,],

                    [36.83716, 138.08618, 1267.2,],

                    [36.83696, 138.0856, 1268.6,],

                    [36.8367, 138.08502, 1268.1,],

                    [36.83643, 138.08457, 1268.4,],

                    [36.83611, 138.08411, 1268.5,],

                    [36.83584, 138.08382, 1266,],

                    [36.83566, 138.08382, 1265.5,],

                    [36.83529, 138.08384, 1265.2,],

                    [36.83528, 138.08384, 1265.2,],

                    [36.83494, 138.08391, 1264.2,],

                    [36.83483, 138.08391, 1263.6,],

                    [36.83461, 138.08391, 1262,],

                    [36.8343, 138.08379, 1264.4,],

                    [36.83412, 138.08371, 1267.3,],

                    [36.8339, 138.0837, 1267.9,],

                    [36.83352, 138.0837, 1264.2,],

                    [36.83333, 138.08375, 1267,],

                    [36.8331, 138.08402, 1265,],

                    [36.83296, 138.08426, 1268.2,],

                    [36.83279, 138.08435, 1261,],

                    [36.83237, 138.084, 1250,],

                    [36.83206, 138.08366, 1244,],

                    [36.83188, 138.08355, 1244.9,],

                    [36.83174, 138.08352, 1243.5,],

                    [36.83158, 138.08356, 1240,],

                    [36.83139, 138.08377, 1245.4,],

                    [36.83137, 138.08388, 1246.4,],

                    [36.83158, 138.0845, 1254.1,],

                    [36.8319, 138.08498, 1254.3,],

                    [36.83208, 138.08529, 1258.2,],

                    [36.83218, 138.08557, 1259.9,],

                    [36.83218, 138.08613, 1262.1,],

                    [36.832, 138.08694, 1269,],

                    [36.83177, 138.08731, 1272,],

                    [36.83122, 138.0882, 1277,],

                    [36.83109, 138.08845, 1278,],

                    [36.83098, 138.08864, 1279,],

                    [36.83015, 138.0895, 1288,],

                    [36.82985, 138.08983, 1291,],

                    [36.82973, 138.08993, 1291,],

                    [36.82955, 138.09011, 1292,],

                    [36.82942, 138.09013, 1292,],

                    [36.82938, 138.09013, 1293,],

                    [36.82932, 138.09009, 1294,],

                    [36.82919, 138.08973, 1297,],

                    [36.82905, 138.08928, 1300,],

                    [36.82903, 138.08916, 1300,],

                    [36.82903, 138.08886, 1301,],

                    [36.82906, 138.08871, 1301,],

                    [36.82895, 138.08844, 1302,],

                    [36.8288, 138.08826, 1304,],

                    [36.82868, 138.088, 1306,],

                    [36.82867, 138.08756, 1306,],

                    [36.82867, 138.0869, 1308,],

                    [36.82863, 138.08663, 1310,],

                    [36.82861, 138.0865, 1310,],

                    [36.82849, 138.08641, 1312,],

                    [36.82842, 138.08636, 1313,],

                    [36.82833, 138.08641, 1314,],

                    [36.82812, 138.08679, 1318,],

                    [36.82788, 138.08727, 1321,],

                    [36.82771, 138.08747, 1323,],

                    [36.8274, 138.08782, 1325,],

                    [36.82738, 138.08785, 1325,],

                    [36.82728, 138.08806, 1326,],

                    [36.8271, 138.08831, 1327,],

                    [36.82702, 138.08842, 1328,],

                    [36.82692, 138.08844, 1329,],

                    [36.82681, 138.08842, 1330,],

                    [36.82681, 138.08822, 1331,],

                    [36.82685, 138.08805, 1332,],

                    [36.82681, 138.0878, 1333,],

                    [36.82667, 138.08731, 1337,],

                    [36.82667, 138.08704, 1337,],

                    [36.82675, 138.08667, 1337,],

                    [36.82685, 138.08628, 1336,],

                    [36.82684, 138.08616, 1336,],

                    [36.82677, 138.08606, 1337,],

                    [36.82668, 138.08604, 1338,],

                    [36.82656, 138.08628, 1340,],

                    [36.82638, 138.08663, 1343,],

                    [36.82604, 138.08693, 1347,],

                    [36.82593, 138.08707, 1348,],

                    [36.82591, 138.08739, 1348,],

                    [36.82573, 138.08778, 1349,],

                    [36.82556, 138.08807, 1351,],

                    [36.82549, 138.08825, 1352,],

                    [36.82543, 138.08852, 1353,],

                    [36.82548, 138.08885, 1351,],

                    [36.82557, 138.08903, 1348,],

                    [36.82571, 138.08923, 1347,],

                    [36.82588, 138.08933, 1346,],

                    [36.82617, 138.08954, 1340,],

                    [36.82637, 138.0898, 1340,],

                    [36.82641, 138.08988, 1338,],

                    [36.82644, 138.09013, 1349,],

                    [36.82627, 138.09096, 1352,],

                    [36.82628, 138.09158, 1338,],

                    [36.82635, 138.09204, 1335,],

                    [36.82638, 138.09213, 1337,],

                    [36.82636, 138.0925, 1343,],

                    [36.82625, 138.09283, 1344,],

                    [36.82618, 138.09319, 1345,],

                    [36.82618, 138.09375, 1348,],

                    [36.82625, 138.09404, 1350,],

            ];
            var polyline = L.polyline(latlngs.map(function(latlng) { return [latlng[0], latlng[1]]; }), {color: 'blue'}).addTo(map);

            // 距離計算関数
            function calculateDistance(lat1, lon1, lat2, lon2) {
                function toRad(x) {
                    return x * Math.PI / 180;
                }
                var R = 6371; // 地球の半径 (km)
                var dLat = toRad(lat2 - lat1);
                var dLon = toRad(lon2 - lon1);
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                        Math.sin(dLon / 2) * Math.sin(dLon / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            // ローパスフィルタによる標高データのスムージング
            function lowPassFilter(elevations, alpha) {
                var smoothed = [elevations[0]]; // 初期値は最初の標高値
                for (var i = 1; i < elevations.length; i++) {
                    var smoothedValue = alpha * elevations[i] + (1 - alpha) * smoothed[i - 1];
                    smoothed.push(smoothedValue);
                }
                return smoothed;
            }

            // 累積距離計算 (水平距離)
            var distances = [0];
            var totalDistance = 0;
            for (var i = 1; i < latlngs.length; i++) {
                var d = calculateDistance(latlngs[i-1][0], latlngs[i-1][1], latlngs[i][0], latlngs[i][1]);
                totalDistance += d;
                distances.push(totalDistance);
            }

            // 累積距離計算 (沿面距離)
            function calculateSurfaceDistance(lat1, lon1, ele1, lat2, lon2, ele2) {
                var horizontalDistance = calculateDistance(lat1, lon1, lat2, lon2);
                var verticalDistance = (ele2 - ele1) / 1000; // m to km
                return Math.sqrt(horizontalDistance * horizontalDistance + verticalDistance * verticalDistance);
            }

            var surfaceDistances = [0];
            var totalSurfaceDistance = 0;
            for (var i = 1; i < latlngs.length; i++) {
                var d = calculateSurfaceDistance(latlngs[i-1][0], latlngs[i-1][1], latlngs[i-1][2], latlngs[i][0], latlngs[i][1], latlngs[i][2]);
                totalSurfaceDistance += d;
                surfaceDistances.push(totalSurfaceDistance);
            }

            // 標高データのスムージング
            var elevations = latlngs.map(function(latlng) { return latlng[2]; });
            var alpha = 0.167; // スムージング係数 (0.0 < alpha < 1.0)
            var smoothedElevations = lowPassFilter(elevations, alpha);

            // 累積標高計算
            var totalAscent = 0;
            var totalDescent = 0;
            var maxElevation = Math.max(...smoothedElevations);
            var minElevation = Math.min(...smoothedElevations);
            for (var i = 1; i < smoothedElevations.length; i++) {
                var diff = smoothedElevations[i] - smoothedElevations[i-1];
                if (diff > 0) {
                    totalAscent += diff;
                } else {
                    totalDescent += Math.abs(diff);
                }
            }

            // 水平距離と沿面距離の表示
            document.getElementById('horizontal-distance').innerText = totalDistance.toFixed(0);
            document.getElementById('surface-distance').innerText = totalSurfaceDistance.toFixed(0);

            // 累積標高と最高・最低標高の表示
            document.getElementById('total-ascent').innerText = totalAscent.toFixed(0);
            document.getElementById('total-descent').innerText = totalDescent.toFixed(0);
            document.getElementById('max-elevation').innerText = maxElevation.toFixed(0);
            document.getElementById('min-elevation').innerText = minElevation.toFixed(0);

            // 標高グラフの初期化
            var graphDiv = document.getElementById('graph');
            Plotly.newPlot(graphDiv, [{
                x: distances,
                y: smoothedElevations,
                type: 'scatter',
                mode: 'lines'
            }], {
                xaxis: { title: '距離 (km)' },
                yaxis: { title: '標高 (m)' }
            });

            // マーカーの初期化
            var marker = L.marker([latlngs[0][0], latlngs[0][1]]).addTo(map);

            // スライダーの設定
            var slider = document.getElementById('slider');
            slider.max = latlngs.length - 1;

            // マーカーとビューを更新する共通関数
            function updateMarkerAndView(idx) {
                var latlng = latlngs[idx];
                marker.setLatLng([latlng[0], latlng[1]]);
                map.setView([latlng[0], latlng[1]], 15);
                Plotly.Fx.hover('graph', [{
                    curveNumber: 0,
                    pointNumber: idx
                }]);
            }

            slider.addEventListener('input', function() {
                var idx = slider.value;
                updateMarkerAndView(idx);
            });

            // グラフのホバーイベント
            graphDiv.on('plotly_hover', function(eventdata) {
                var idx = eventdata.points[0].pointNumber;
                slider.value = idx;
                updateMarkerAndView(idx);
            });

            // グラフのクリックイベント
            graphDiv.on('plotly_click', function(eventdata) {
                var idx = eventdata.points[0].pointNumber;
                slider.value = idx;
                updateMarkerAndView(idx);
            });

            // 初期距離表示更新
            updateMarkerAndView(0);
        });
    </script>
</body>
</html>
