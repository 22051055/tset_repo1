<!DOCTYPE html>
<html>
<head>
    <title>西登山口to大橋林道</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <style>
        #map, #graph {
            width: 100%;
            height: 50vh;
        }
        #slider-container {
            display: flex;
            justify-content: center;
            margin-top: 0px;
        }
        #slider {
            width: 100%;
        }
        #distances, #elevations {
            text-align: center;
            margin-top: 10px;
        }        
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
</head>
<body>
    <div id="title"><a>西登山口to大橋林道</a></div>
    <div id="map"></div>
    <div id="graph" style="touch-action: manipulation;"></div>
    <div id="slider-container">
        <input type="range" id="slider" min="0" max="100" value="0" />
    </div>
    <div id="distances">
        <p>水平距離: <span id="horizontal-distance"></span> km</p>
        <p>沿面距離: <span id="surface-distance"></span> km</p>
    </div>
    <div id="elevations">
        <p>累積標高上り: <span id="total-ascent"></span> m</p>
        <p>累積標高下り: <span id="total-descent"></span> m</p>
        <p>最高標高: <span id="max-elevation"></span> m</p>
        <p>最低標高: <span id="min-elevation"></span> m</p>
    </div>
    <div>
        <a href="/uploads/processed_2_2Nishitozannguthi_to_Oohashirindo.gpx_viewer.html" download>GPXファイルをダウンロード</a>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
　　<script>
        $(document).ready(function() {
            // 地図の初期化
            var map = L.map('map').setView([36.82625, 138.09404], 14);
            L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>'
            }).addTo(map);

            // GPXトラックの表示
            var latlngs = [
                
                    [36.82625, 138.09404, 1350,],

                    [36.82619, 138.09413, 1350,],

                    [36.82573, 138.09482, 1357,],

                    [36.82542, 138.09523, 1363,],

                    [36.82527, 138.09565, 1366,],

                    [36.82518, 138.09574, 1367,],

                    [36.82502, 138.09597, 1369,],

                    [36.8245, 138.09637, 1376,],

                    [36.82435, 138.0964, 1378,],

                    [36.82409, 138.09631, 1384,],

                    [36.82386, 138.09604, 1389,],

                    [36.82352, 138.09594, 1398,],

                    [36.82338, 138.09589, 1402,],

                    [36.82291, 138.09603, 1407,],

                    [36.82251, 138.09633, 1419,],

                    [36.82231, 138.0964, 1422,],

                    [36.82187, 138.09635, 1428,],

                    [36.82163, 138.09629, 1432,],

                    [36.82136, 138.09623, 1439,],

                    [36.82122, 138.09622, 1441,],

                    [36.82112, 138.09635, 1439,],

                    [36.82112, 138.09669, 1442,],

                    [36.82099, 138.09715, 1448,],

                    [36.8209, 138.09731, 1450,],

                    [36.82078, 138.09739, 1452,],

                    [36.82061, 138.09766, 1455,],

                    [36.82051, 138.09786, 1457,],

                    [36.82053, 138.09801, 1458,],

                    [36.82066, 138.0983, 1459,],

                    [36.82052, 138.09863, 1462,],

                    [36.82046, 138.09884, 1464,],

                    [36.82053, 138.09918, 1465,],

                    [36.82035, 138.09977, 1467,],

                    [36.82034, 138.09993, 1468,],

                    [36.82072, 138.10036, 1475,],

                    [36.82073, 138.1006, 1483,],

                    [36.82117, 138.10075, 1496,],

                    [36.82118, 138.1009, 1499,],

                    [36.82113, 138.10102, 1502,],

                    [36.82105, 138.10108, 1504,],

                    [36.82095, 138.10117, 1507,],

                    [36.8208, 138.10128, 1509,],

                    [36.82078, 138.10133, 1513,],

                    [36.82091, 138.10143, 1515,],

                    [36.8209, 138.10152, 1517,],

                    [36.82061, 138.10166, 1525,],

                    [36.82064, 138.1019, 1533,],

                    [36.82063, 138.10204, 1537,],

                    [36.8205, 138.10225, 1543,],

                    [36.81991, 138.10252, 1554,],

                    [36.81979, 138.10261, 1559,],

                    [36.81951, 138.10271, 1561,],

                    [36.8192, 138.10297, 1570,],

                    [36.819, 138.10314, 1575,],

                    [36.81889, 138.10325, 1578,],

                    [36.81883, 138.10326, 1579,],

                    [36.81875, 138.10316, 1579,],

                    [36.8186, 138.10288, 1577,],

                    [36.81837, 138.10259, 1576,],

                    [36.81818, 138.10237, 1577,],

                    [36.81801, 138.10229, 1578,],

                    [36.8177, 138.10229, 1579,],

                    [36.81731, 138.10224, 1582,],

                    [36.81706, 138.10223, 1583,],

                    [36.81641, 138.10224, 1584,],

                    [36.816, 138.10217, 1585,],

                    [36.81558, 138.10211, 1590,],

                    [36.81516, 138.10199, 1594,],

                    [36.81473, 138.10187, 1596,],

                    [36.81449, 138.1018, 1597,],

                    [36.81439, 138.10177, 1597,],

                    [36.81426, 138.10177, 1597,],

                    [36.81411, 138.10165, 1596,],

                    [36.81402, 138.10151, 1596,],

                    [36.81398, 138.10131, 1593,],

                    [36.81398, 138.10105, 1591,],

                    [36.81393, 138.10077, 1591,],

                    [36.81384, 138.10065, 1592,],

                    [36.81374, 138.10056, 1594,],

                    [36.81344, 138.10056, 1598,],

                    [36.81311, 138.10055, 1599,],

                    [36.81289, 138.10048, 1599,],

                    [36.81255, 138.1004, 1599,],

                    [36.81226, 138.10036, 1602,],

                    [36.81204, 138.10036, 1602,],

                    [36.81167, 138.10037, 1604,],

                    [36.81135, 138.10053, 1602,],

                    [36.811, 138.10071, 1597,],

                    [36.81066, 138.10087, 1592,],

                    [36.81038, 138.10095, 1586,],

                    [36.81038, 138.10095, 1586,],

                    [36.81013, 138.10097, 1585,],

                    [36.80963, 138.10097, 1577,],

                    [36.80921, 138.10092, 1566,],

                    [36.80898, 138.10092, 1562,],

                    [36.80874, 138.10091, 1555,],

                    [36.80833, 138.10074, 1548,],

                    [36.80787, 138.10058, 1539,],

                    [36.80765, 138.10058, 1535,],

                    [36.80747, 138.10058, 1532,],

                    [36.80747, 138.10069, 1530,],

                    [36.8075, 138.10095, 1526,],

                    [36.8075, 138.10105, 1526,],

                    [36.80737, 138.10116, 1528,],

                    [36.80705, 138.10117, 1524,],

                    [36.80682, 138.10122, 1522,],

                    [36.80637, 138.10123, 1516,],

                    [36.80637, 138.10123, 1516,],

                    [36.80617, 138.10126, 1516,],

                    [36.80595, 138.10134, 1516,],

                    [36.80517, 138.10134, 1514,],

                    [36.80481, 138.10134, 1508,],

                    [36.80456, 138.10133, 1507,],

                    [36.80438, 138.10129, 1501,],

                    [36.8042, 138.10129, 1499,],

                    [36.80389, 138.10117, 1495,],

                    [36.80365, 138.10111, 1489,],

                    [36.80366, 138.10111, 1489,],

                    [36.80359, 138.10112, 1488,],

                    [36.80325, 138.10106, 1486,],

                    [36.80314, 138.10107, 1486,],

                    [36.803, 138.10115, 1485,],

                    [36.803, 138.10115, 1485,],

                    [36.80293, 138.1011, 1484,],

                    [36.80269, 138.10086, 1480,],

                    [36.80258, 138.10068, 1477,],

                    [36.80251, 138.10063, 1475,],

                    [36.8023, 138.10048, 1471,],

                    [36.80205, 138.10014, 1466,],

                    [36.80201, 138.09982, 1465,],

                    [36.80204, 138.09955, 1463,],

                    [36.80204, 138.09922, 1461,],

                    [36.80203, 138.09895, 1457,],

                    [36.80197, 138.09875, 1455,],

                    [36.80194, 138.09862, 1452,],

                    [36.8019, 138.0985, 1451,],

                    [36.80188, 138.09839, 1446,],

                    [36.8018, 138.09821, 1439,],

                    [36.80187, 138.09815, 1439,],

                    [36.80197, 138.09811, 1436,],

                    [36.80199, 138.09804, 1434,],

                    [36.80195, 138.09794, 1431,],

                    [36.80181, 138.09786, 1428,],

                    [36.8017, 138.09783, 1428,],

                    [36.80164, 138.09777, 1424,],

                    [36.80166, 138.0976, 1420,],

                    [36.80174, 138.0974, 1417,],

                    [36.8017, 138.09722, 1414,],

                    [36.80153, 138.097, 1409,],

                    [36.80146, 138.09691, 1407,],

                    [36.80132, 138.09687, 1406,],

                    [36.80108, 138.0969, 1402,],

                    [36.80099, 138.09696, 1402,],

                    [36.80077, 138.09701, 1399,],

                    [36.80076, 138.09685, 1394,],

                    [36.80072, 138.09671, 1391,],

                    [36.80069, 138.09663, 1388,],

                    [36.80063, 138.0966, 1388,],

                    [36.80052, 138.09663, 1387,],

                    [36.80027, 138.09687, 1387,],

                    [36.80019, 138.09689, 1386,],

                    [36.80016, 138.09692, 1386,],

                    [36.80012, 138.09697, 1385,],

                    [36.80004, 138.09704, 1384,],

                    [36.79994, 138.09709, 1383,],

                    [36.79986, 138.09719, 1382,],

                    [36.79975, 138.09719, 1381,],

                    [36.79969, 138.09719, 1379,],

                    [36.7996, 138.09704, 1377,],

                    [36.79948, 138.09701, 1373,],

                    [36.79937, 138.09705, 1370,],

                    [36.79931, 138.09717, 1368,],

                    [36.79924, 138.09722, 1366,],

                    [36.79918, 138.09716, 1365,],

                    [36.79903, 138.09698, 1359,],

                    [36.79893, 138.09697, 1358,],

                    [36.79879, 138.09706, 1355,],

                    [36.79864, 138.09721, 1354,],

                    [36.79858, 138.09756, 1353,],

                    [36.79847, 138.09798, 1346,],

                    [36.79856, 138.09841, 1345,],

                    [36.79854, 138.09857, 1344,],

                    [36.7984, 138.09865, 1341,],

                    [36.79825, 138.09874, 1337,],

                    [36.798, 138.09883, 1330,],

                    [36.79789, 138.09867, 1328,],

                    [36.7978, 138.09866, 1326,],

                    [36.79758, 138.09876, 1322,],

                    [36.79715, 138.09906, 1310,],

                    [36.79696, 138.09927, 1304,],

                    [36.7969, 138.09931, 1302,],

                    [36.79676, 138.09925, 1296,],

                    [36.79665, 138.09916, 1293,],

                    [36.79666, 138.09902, 1293,],

                    [36.79688, 138.09854, 1303,],

                    [36.79685, 138.09817, 1300,],

                    [36.79678, 138.09792, 1297,],

                    [36.79669, 138.09764, 1292,],

                    [36.79666, 138.09743, 1288,],

                    [36.79661, 138.09734, 1286,],

                    [36.79646, 138.09725, 1284,],

                    [36.7963, 138.09724, 1283,],

                    [36.79619, 138.09731, 1281,],

                    [36.79594, 138.09738, 1279,],

                    [36.79582, 138.09741, 1278,],

                    [36.79555, 138.09735, 1275,],

                    [36.79535, 138.09737, 1271,],

                    [36.79514, 138.0975, 1268,],

                    [36.79511, 138.09753, 1267,],

                    [36.79479, 138.09775, 1263,],

                    [36.79475, 138.09779, 1262,],

                    [36.79421, 138.09793, 1256,],

                    [36.79372, 138.09796, 1251,],

                    [36.79367, 138.09796, 1250,],

                    [36.79335, 138.09799, 1248,],

                    [36.79098, 138.09836, 1225,],

                    [36.79087, 138.09834, 1224,],

                    [36.79063, 138.09819, 1221,],

                    [36.7899, 138.09778, 1209,],

                    [36.78927, 138.09777, 1204,],

                    [36.78891, 138.09775, 1202,],

                    [36.78869, 138.09775, 1200,],

                    [36.78804, 138.09783, 1195,],

                    [36.78783, 138.0978, 1194,],

                    [36.78685, 138.09738, 1188,],

                    [36.78654, 138.09723, 1186,],

                    [36.78623, 138.09719, 1184,],

                    [36.78603, 138.09722, 1182,],

                    [36.7856, 138.09725, 1179,],

                    [36.7849, 138.09744, 1174,],

            ];
            var polyline = L.polyline(latlngs.map(function(latlng) { return [latlng[0], latlng[1]]; }), {color: 'blue'}).addTo(map);

            // 距離計算関数
            function calculateDistance(lat1, lon1, lat2, lon2) {
                function toRad(x) {
                    return x * Math.PI / 180;
                }
                var R = 6371; // 地球の半径 (km)
                var dLat = toRad(lat2 - lat1);
                var dLon = toRad(lon2 - lon1);
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                        Math.sin(dLon / 2) * Math.sin(dLon / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            // ローパスフィルタによる標高データのスムージング
            function lowPassFilter(elevations, alpha) {
                var smoothed = [elevations[0]]; // 初期値は最初の標高値
                for (var i = 1; i < elevations.length; i++) {
                    var smoothedValue = alpha * elevations[i] + (1 - alpha) * smoothed[i - 1];
                    smoothed.push(smoothedValue);
                }
                return smoothed;
            }

            // 累積距離計算 (水平距離)
            var distances = [0];
            var totalDistance = 0;
            for (var i = 1; i < latlngs.length; i++) {
                var d = calculateDistance(latlngs[i-1][0], latlngs[i-1][1], latlngs[i][0], latlngs[i][1]);
                totalDistance += d;
                distances.push(totalDistance);
            }

            // 累積距離計算 (沿面距離)
            function calculateSurfaceDistance(lat1, lon1, ele1, lat2, lon2, ele2) {
                var horizontalDistance = calculateDistance(lat1, lon1, lat2, lon2);
                var verticalDistance = (ele2 - ele1) / 1000; // m to km
                return Math.sqrt(horizontalDistance * horizontalDistance + verticalDistance * verticalDistance);
            }

            var surfaceDistances = [0];
            var totalSurfaceDistance = 0;
            for (var i = 1; i < latlngs.length; i++) {
                var d = calculateSurfaceDistance(latlngs[i-1][0], latlngs[i-1][1], latlngs[i-1][2], latlngs[i][0], latlngs[i][1], latlngs[i][2]);
                totalSurfaceDistance += d;
                surfaceDistances.push(totalSurfaceDistance);
            }

            // 標高データのスムージング
            var elevations = latlngs.map(function(latlng) { return latlng[2]; });
            var alpha = 0.167; // スムージング係数 (0.0 < alpha < 1.0)
            var smoothedElevations = lowPassFilter(elevations, alpha);

            // 累積標高計算
            var totalAscent = 0;
            var totalDescent = 0;
            var maxElevation = Math.max(...smoothedElevations);
            var minElevation = Math.min(...smoothedElevations);
            for (var i = 1; i < smoothedElevations.length; i++) {
                var diff = smoothedElevations[i] - smoothedElevations[i-1];
                if (diff > 0) {
                    totalAscent += diff;
                } else {
                    totalDescent += Math.abs(diff);
                }
            }

            // 水平距離と沿面距離の表示
            document.getElementById('horizontal-distance').innerText = totalDistance.toFixed(0);
            document.getElementById('surface-distance').innerText = totalSurfaceDistance.toFixed(0);

            // 累積標高と最高・最低標高の表示
            document.getElementById('total-ascent').innerText = totalAscent.toFixed(0);
            document.getElementById('total-descent').innerText = totalDescent.toFixed(0);
            document.getElementById('max-elevation').innerText = maxElevation.toFixed(0);
            document.getElementById('min-elevation').innerText = minElevation.toFixed(0);

            // 標高グラフの初期化
            var graphDiv = document.getElementById('graph');
            Plotly.newPlot(graphDiv, [{
                x: distances,
                y: smoothedElevations,
                type: 'scatter',
                mode: 'lines'
            }], {
                xaxis: { title: '距離 (km)' },
                yaxis: { title: '標高 (m)' }
            });

            // マーカーの初期化
            var marker = L.marker([latlngs[0][0], latlngs[0][1]]).addTo(map);

            // スライダーの設定
            var slider = document.getElementById('slider');
            slider.max = latlngs.length - 1;

            // マーカーとビューを更新する共通関数
            function updateMarkerAndView(idx) {
                var latlng = latlngs[idx];
                marker.setLatLng([latlng[0], latlng[1]]);
                map.setView([latlng[0], latlng[1]], 15);
                Plotly.Fx.hover('graph', [{
                    curveNumber: 0,
                    pointNumber: idx
                }]);
            }

            slider.addEventListener('input', function() {
                var idx = slider.value;
                updateMarkerAndView(idx);
            });

            // グラフのホバーイベント
            graphDiv.on('plotly_hover', function(eventdata) {
                var idx = eventdata.points[0].pointNumber;
                slider.value = idx;
                updateMarkerAndView(idx);
            });

            // グラフのクリックイベント
            graphDiv.on('plotly_click', function(eventdata) {
                var idx = eventdata.points[0].pointNumber;
                slider.value = idx;
                updateMarkerAndView(idx);
            });

            // 初期距離表示更新
            updateMarkerAndView(0);
        });
    </script>
</body>
</html>
